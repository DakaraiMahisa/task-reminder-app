<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>All Tasks</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <link rel="stylesheet" th:href="@{/css/tasks.css}">
</head>

<body>

<div class="page-container">
    <!-- =====================================================
    TOP NAVIGATION BAR
    ===================================================== -->
    <nav class="top-nav">
        <div class="nav-left">
            <span class="app-title">
                <i class="fa-solid fa-list-check app-icon"></i>
                Task Reminder App</span>
        </div>

        <div class="nav-right">
            <a href="/api/tasks/add" class="nav-btn">
                <i class="fa-solid fa-plus"></i>Add Task
            </a>
            <a href="/" class="nav-btn">
                <i class="fa-solid fa-house"></i>Home
            </a>
        </div>

    </nav>

    <!-- =====================================================
         HEADER / PAGE INTRO
         ===================================================== -->
    <header class="page-header">
        <h2>Task List</h2>
    </header>


    <!-- =====================================================
         FEEDBACK / NOTIFICATIONS
         ===================================================== -->
    <section class="notifications">

        <!-- SUCCESS MESSAGE -->
        <div th:if="${successMessage}"
             class="success-message"
             th:text="${successMessage}">
        </div>

        <!-- ERROR MESSAGE -->
        <div th:if="${errorMessage}"
             class="error-message"
             th:text="${errorMessage}">
        </div>

    </section>


    <!-- =====================================================
         FILTER, SEARCH & SORT CONTROLS
         ===================================================== -->
    <section class="task-controls">

        <form method="get" action="/api/tasks" class="filter-form">

            <div class="filter-group">

                <!-- Status Filter -->
                <div class="filter-item">
                    <label>Status</label>
                    <select name="status">
                        <option value="">All</option>
                        <option value="PENDING" th:selected="${status == 'PENDING'}">Pending</option>
                        <option value="IN_PROGRESS" th:selected="${status == 'IN_PROGRESS'}">In Progress</option>
                        <option value="DONE" th:selected="${status == 'DONE'}">Done</option>
                    </select>
                </div>

                <!-- Priority Filter -->
                <div class="filter-item">
                    <label>Priority</label>
                    <select name="priority">
                        <option value="">All</option>
                        <option value="LOW" th:selected="${priority == 'LOW'}">Low</option>
                        <option value="MEDIUM" th:selected="${priority == 'MEDIUM'}">Medium</option>
                        <option value="HIGH" th:selected="${priority == 'HIGH'}">High</option>
                    </select>
                </div>

                <!-- Title Search -->
                <div class="filter-item">
                    <label>Title</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text"
                               name="title"
                               th:value="${title}"
                               placeholder="Search title">
                    </div>
                </div>

                <!-- Sort By -->
                <div class="filter-item">
                    <label>Sort By</label>
                    <select name="sortBy">
                        <option value="dueDate" th:selected="${sortBy == 'dueDate'}">Due Date</option>
                        <option value="priority" th:selected="${sortBy == 'priority'}">Priority</option>
                        <option value="title" th:selected="${sortBy == 'title'}">Title</option>
                    </select>
                </div>

                <!-- Actions -->
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-filter"></i>
                        Apply Filters
                    </button>

                    <a href="/api/tasks" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i>
                        Clear Filters
                    </a>
                </div>

            </div>
        </form>

    </section>


    <!-- =====================================================
         MAIN CONTENT
         ===================================================== -->
    <main class="content">

        <!-- ===============================================
             TASK TABLE
             =============================================== -->

        <div class="view-switcher">
            <a th:href="@{/api/tasks(view='table')}"
               class="view-btn"
                th:classappend="${view == 'table'} ? ' active'">
                <i class="fa-solid fa-table"></i>
                Table View
            </a>

            <a th:href="@{/api/tasks(view='card')}"
               class="view-btn"
                th:classappend="${view == 'card'} ? ' active'">
                <i class="fa-solid fa-grip"></i>
                Card View
            </a>

            <a th:href="@{/api/tasks(view='calendar')}"
               class="view-btn"
                th:classappend="${view == 'calendar'} ? ' active'">
                <i class="fa-solid fa-calendar-days"></i>
                Calendar View
            </a>
        </div>

        <section class="task-list" th:if="${view == 'table'}">

            <table class="task-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Created At</th>
                    <th>Completed At</th>
                    <th>Actions</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="task : ${tasks}">
                <td th:text="${task.id}"></td>
                    <td th:text="${task.title}"></td>
                    <td th:text="${task.description}"></td>
                    <td th:text="${task.dueDate}"></td>
                    <td>
    <span class="badge status"
          th:text="${task.status.label}"
          th:classappend="' status-' + ${task.status}">
    </span>
                    </td>

                    <td>
    <span class="badge priority"
          th:text="${task.priority.label}"
          th:classappend="' priority-' + ${task.priority}">
    </span>
                    </td>

                    <td th:text="${#temporals.format(task.createdAt, 'yyyy-MM-dd')}"></td>
                    <td th:text="${task.completedAt != null
                        ? #temporals.format(task.completedAt, 'yyyy-MM-dd')
                        : '-'}">
                    </td>

                    <td class="action-buttons">
                        <a class="btn btn-view"
                           th:href="@{/api/view/{id}(id=${task.id})}"
                           title="View Task">
                            <i class="fa-solid fa-eye"></i> View
                        </a>

                        <a class="btn btn-edit"
                           th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}"
                           th:href="@{/api/tasks/update/{id}(id=${task.id})}"
                           title="Edit Task">
                            <i class="fa-solid fa-pen"></i>Edit
                        </a>
                        <span class="btn btn-edit btn-disabled"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}"
                              title="Completed tasks cannot be edited">
                              <i class="fa-solid fa-pen"></i> Edit
                        </span>


                        <a class="btn btn-danger"
                           th:href="@{/api/tasks/delete/{id}(id=${task.id})}"
                           title="Delete Task"
                           onclick="return confirm('Are you sure you want to delete this task?');">
                            <i class="fa-solid fa-trash"></i>Delete
                        </a>

                        <a class="btn btn-info"
                           th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}"
                           th:href="@{/api/tasks/mark-done/{id}(id=${task.id})}">
                            <i class="fa-solid fa-check"></i>Mark Done
                        </a>
                        <span class="completed-label"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}">
                              <i class="fa-solid fa-circle-check"></i> Done
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>

        </section>
        <!-- ===============================================
    CARD VIEW
    =============================================== -->
        <section class="card-view"
                 th:if="${view == 'card'}">

            <div class="task-card-grid">

                <div class="task-card"
                     th:each="task : ${tasks}"
                     th:classappend="
                ${task.priority.name() == 'HIGH'} ? ' priority-high' :
                (${task.priority.name() == 'MEDIUM'} ? ' priority-medium' : ' priority-low')
             ">

                    <!-- Card Header -->
                    <div class="task-card-header">
                        <h3 th:text="${task.title}"></h3>
                    </div>

                    <!-- Card Body -->
                    <div class="task-card-body">
                        <p class="description"
                           th:text="${task.description}"></p>

                        <p class="meta">
                            <strong>Due Date:</strong>
                            <span th:text="${task.dueDate}"></span>
                        </p>

                        <p class="meta task-priority">
                            <strong>Priority:</strong>
                            <span th:text="${task.priority.label}"></span>
                        </p>

                        <p class="meta">
                            <strong>Status:</strong>
                            <span class="badge status"
                                  th:text="${task.status.label}"
                                  th:classappend="' status-' + ${task.status}">
                    </span>
                        </p>
                    </div>

                    <!-- Card Actions -->
                    <div class="task-card-actions">

                        <a class="btn btn-view"
                           th:href="@{/api/view/{id}(id=${task.id})}">
                            <i class="fa-solid fa-eye"></i> View
                        </a>

                        <a class="btn btn-edit"
                           th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}"
                           th:href="@{/api/tasks/update/{id}(id=${task.id})}">
                            <i class="fa-solid fa-pen"></i> Edit
                        </a>

                        <span class="btn btn-edit btn-disabled"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}">
                    <i class="fa-solid fa-pen"></i> Edit
                </span>

                        <a class="btn btn-danger"
                           th:href="@{/api/tasks/delete/{id}(id=${task.id})}"
                           onclick="return confirm('Delete this task?');">
                            <i class="fa-solid fa-trash"></i> Delete
                        </a>
                    </div>

                    <!-- Footer -->
                    <div class="task-card-footer">

                        <a class="btn btn-info"
                           th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}"
                           th:href="@{/api/tasks/mark-done/{id}(id=${task.id})}">
                            <i class="fa-solid fa-check"></i> Mark Done
                        </a>

                        <span class="completed-label"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}">
                    <i class="fa-solid fa-circle-check"></i> Done
                </span>

                    </div>

                </div>

            </div>

        </section>

        <!-- ===============================================
     CALENDAR VIEW
     =============================================== -->
        <section class="calendar-view"
                 th:if="${view == 'calendar'}">

            <div id="taskCalendar"></div>

        </section>

        <!-- ===============================================
             PAGINATION
             =============================================== -->
        <section class="pagination-container"
                 th:if="${totalPages > 1}">

            <a class="btn"
               th:if="${currentPage > 0}"
               th:href="@{/api/tasks(
                   page=${currentPage - 1},
                   size=${size},
                   status=${status},
                   priority=${priority},
                   title=${title},
                   sortBy=${sortBy},
                   view=${view}
               )}">
                Previous
            </a>

            <span class="page-info">
                Page <strong th:text="${currentPage + 1}"></strong>
                of <strong th:text="${totalPages}"></strong>
            </span>

            <a class="btn"
               th:if="${currentPage < totalPages - 1}"
               th:href="@{/api/tasks(
                   page=${currentPage + 1},
                   size=${size},
                   status=${status},
                   priority=${priority},
                   title=${title},
                   sortBy=${sortBy},
                   view=${view}
               )}">
                Next
            </a>

        </section>

    </main>


    <!-- =====================================================
         FOOTER
         ===================================================== -->
    <footer class="footer">
        <div class="footer-content">
            <span>Task Reminder App</span>
            <span>&copy; 2025</span>
            <span>Created by Dakarai Mahisa</span>
        </div>
    </footer>

</div>

<script th:if="${view == 'calendar'}">
    document.addEventListener('DOMContentLoaded', function () {

        const calendarEl = document.getElementById('taskCalendar');
        if (!calendarEl) {
            return;
        }

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 650,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/api/tasks/calendar',
            eventClick: function(info) {
                window.location.href = '/api/view/' + info.event.id;
            }
        });

        calendar.render();
    });
</script>
</body>
</html>
