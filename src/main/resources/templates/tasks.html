<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">

    <title>All Tasks</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script>
        (function () {
            const isCollapsed = localStorage.getItem("sidebar-collapsed") === "true";
            if (isCollapsed) {
                document.documentElement.classList.add("sidebar-collapsed");
            }
        })();
    </script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/dark-mode.css}">
    <link rel="stylesheet" th:href="@{/css/tasks.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">

</head>

<body>

<div th:replace="~{fragments/header :: header('tasks')}"></div>
    <aside th:replace="~{fragments/sidebar ::sidebar('tasks')}"></aside>
<div class="page-container">
    <!-- =====================================================
         HEADER / PAGE INTRO
         ===================================================== -->
    <header class="page-header">
        <h2>Task List</h2>
    </header>

    <section th:if="${dueTodayCount > 0}" class="due-today-banner">
        <i class="fa-solid fa-triangle-exclamation"></i>

        <strong th:text="'Due Today (' + ${dueTodayCount} + ')'"></strong>

        <ul>
            <li th:each="task : ${dueTodayTasks}">
                <a th:href="@{/api/view/{id}(id=${task.id})}"
                   th:text="${task.title}"></a>
            </li>
        </ul>
    </section>

    <!-- =====================================================
         FEEDBACK / NOTIFICATIONS
         ===================================================== -->
    <section class="notifications">

        <!-- SUCCESS MESSAGE -->
        <div th:if="${successMessage != null or session.successMessage != null}"
             class="success-message"
             th:text="${successMessage != null ? successMessage : session.successMessage}">
        </div>

        <!-- ERROR MESSAGE -->
        <div th:if="${errorMessage}"
             class="error-message"
             th:text="${errorMessage}">
        </div>
    </section>

    <!-- =========================================================
   TASK SUMMARY / METRICS
========================================================== -->
    <section class="task-summary">

        <!-- TOTAL TASKS -->
        <div class="summary-card">
            <div class="summary-icon total">
                <i class="fa-solid fa-list-check"></i>
            </div>
            <div class="summary-content">
                <span class="summary-value" th:text="${totalTasks}">0</span>
                <span class="summary-label">Total Tasks</span>
            </div>
        </div>

        <!-- PENDING TASKS -->
        <div class="summary-card pending">
            <div class="summary-icon pending">
                <i class="fa-solid fa-hourglass-half"></i>
            </div>
            <div class="summary-content">
                <span class="summary-value" th:text="${pendingTasks}">0</span>
                <span class="summary-label">Pending</span>
            </div>
        </div>

        <!-- COMPLETED TASKS -->
        <div class="summary-card completed">
            <div class="summary-icon completed">
                <i class="fa-solid fa-circle-check"></i>
            </div>
            <div class="summary-content">
                <span class="summary-value" th:text="${completedTasks}">0</span>
                <span class="summary-label">Completed</span>
            </div>
        </div>

        <!-- PROGRESS -->
        <div class="summary-card progress">
            <div class="progress-ring">

                <svg width="64" height="64">
                    <circle class="ring-bg"
                            cx="32" cy="32" r="28" />
                    <circle class="ring-progress"
                            cx="32" cy="32" r="28"
                            th:attr="stroke-dashoffset=${175 - (175 * progressPercent / 100)}" />
                </svg>

                <span class="progress-text"
                      th:text="|${progressPercent}%|">0%</span>

            </div>
            <span class="summary-label">Progress</span>
        </div>

    </section>


    <!-- =====================================================
         FILTER, SEARCH & SORT CONTROLS
         ===================================================== -->
    <section class="task-controls">

        <div class="error-banner" th:if="${error}">
            <i class="fa-solid fa-circle-exclamation"></i>
            <span th:text="${error}"></span>
        </div>
        <form method="get" action="/api/tasks" class="filter-form">

            <div class="filter-group">

                <!-- Status Filter -->
                <div class="filter-item">
                    <label>Status</label>
                    <select name="status">
                        <option value="">All</option>
                        <option value="PENDING" th:selected="${status == 'PENDING'}">Pending</option>
                        <option value="IN_PROGRESS" th:selected="${status == 'IN_PROGRESS'}">In Progress</option>
                        <option value="DONE" th:selected="${status == 'DONE'}">Done</option>
                    </select>
                </div>

                <!-- Priority Filter -->
                <div class="filter-item">
                    <label>Priority</label>
                    <select name="priority">
                        <option value="">All</option>
                        <option value="LOW" th:selected="${priority == 'LOW'}">Low</option>
                        <option value="MEDIUM" th:selected="${priority == 'MEDIUM'}">Medium</option>
                        <option value="HIGH" th:selected="${priority == 'HIGH'}">High</option>
                    </select>
                </div>

                <!-- Title Search -->
                <div class="filter-item">
                    <label>Title</label>
                    <div class="input-with-icon">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text"
                               name="title"
                               th:value="${title}"
                               placeholder="Search title">
                    </div>
                </div>

                <!-- Filter By (Select active filters) -->
                <div class="filter-item">
                    <label>Filter By</label>

                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox"
                                   name="filters"
                                   value="status"
                                   th:checked="${#lists.contains(filters, 'status')}">
                            Status
                        </label>

                        <label>
                            <input type="checkbox"
                                   name="filters"
                                   value="priority"
                                   th:checked="${#lists.contains(filters, 'priority')}">
                            Priority
                        </label>

                        <label>
                            <input type="checkbox"
                                   name="filters"
                                   value="title"
                                   th:checked="${#lists.contains(filters, 'title')}">
                            Title
                        </label>
                    </div>
                </div>


                <!-- Actions -->
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-filter"></i>
                        Apply Filters
                    </button>

                    <a href="/api/tasks" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i>
                        Clear Filters
                    </a>
                </div>

            </div>
        </form>

    </section>


    <!-- =====================================================
         MAIN CONTENT
         ===================================================== -->
    <main class="content">

        <!-- ===============================================
             TASK TABLE
             =============================================== -->

        <div class="view-switcher">
            <a th:href="@{/api/tasks(view='table')}"
               class="view-btn"
                th:classappend="${view == 'table'} ? ' active'">
                <i class="fa-solid fa-table"></i>
                Table View
            </a>

            <a th:href="@{/api/tasks(view='card')}"
               class="view-btn"
                th:classappend="${view == 'card'} ? ' active'">
                <i class="fa-solid fa-grip"></i>
                Card View
            </a>

            <a th:href="@{/api/tasks(view='calendar')}"
               class="view-btn"
                th:classappend="${view == 'calendar'} ? ' active'">
                <i class="fa-solid fa-calendar-days"></i>
                Calendar View
            </a>
            <div class="dropdown d-inline-block">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-file-export me-1"></i> Export Tasks
                </button>
                <ul class="dropdown-menu shadow" aria-labelledby="exportDropdown">
                    <li>
                        <a class="dropdown-item" th:href="@{/api/tasks/export-csv(action='download')}">
                            <i class="fa-solid fa-download me-2 text-primary"></i> Download CSV
                        </a>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <button type="button" class="dropdown-item" onclick="sendEmailReport()">
                            <i class="fa-solid fa-envelope me-2 text-success"></i> Send to Email
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        <section class="task-list" th:if="${view == 'table'}">

            <table class="task-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Created At</th>
                    <th>Completed At</th>
                    <th>Actions <input type="checkbox" id="selectAllTasks"></th>
                </tr>
                </thead>

                <tbody>
                <tr th:if="${tasks.isEmpty()}">
                    <td colspan="9" class="empty-state">
                        <i class="fa-solid fa-inbox"></i>
                        <p>No tasks found. Try adjusting filters or add a new task.</p>
                    </td>
                </tr>

                <tr th:each="task : ${tasks}"
                    th:classappend="${task.overdue} ? 'overdue-row'">
                <td th:text="${task.id}"></td>
                    <td th:text="${task.title}"></td>
                    <td th:text="${task.description}"></td>
                    <td th:text="${task.dueDate}"></td>
                    <td class="status-cell">
                        <input type="checkbox"
                               class="status-checkbox"
                               th:checked="${task.status.name() == 'DONE'}"
                               th:data-id="${task.id}"
                               th:disabled="${task.status.name() == 'DONE'}"/>

                        <span class="badge status"
                              th:text="${task.status.label}"
                              th:classappend="${'status-' + task.status.name()}">
                        </span>
                    </td>


                    <td>
                         <span class="badge priority"
                         th:text="${task.priority.label}"
                         th:classappend="${'priority-' + task.priority.name()}">
                         </span>
                    </td>

                    <td th:text="${#temporals.format(task.createdAt, 'yyyy-MM-dd')}"></td>
                    <td th:text="${task.completedAt != null
                        ? #temporals.format(task.completedAt, 'yyyy-MM-dd')
                        : '-'}">
                    </td>

                    <td class="action-buttons">
                        <button type="button" class="btn btn-view" th:onclick="'openViewModal(' + ${task.id} + ')'">
                            <i class="fa-solid fa-eye"></i> View
                        </button>

                        <button type="button"
                                class="btn btn-edit"
                                th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}"
                                th:onclick="'openEditModal(' + ${task.id} + ')'">
                            <i class="fa-solid fa-pen"></i> Edit
                        </button>

                        <span class="btn btn-edit btn-disabled"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}">
                              <i class="fa-solid fa-pen"></i> Edit
                        </span>

                        <button type="button"
                                class="btn btn-danger"
                                th:onclick="'deleteSingleTask(' + ${task.id} + ')'"
                                title="Delete Task">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>

                        <button class="btn btn-info mark-done-btn"
                                th:data-id="${task.id}"
                                th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}">
                            <i class="fa-solid fa-check"></i> Mark Done
                        </button>

                        <span class="completed-label"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}">
                              <i class="fa-solid fa-circle-check"></i> Done
                        </span>
                        <input type="checkbox"
                               class="task-select"
                               th:value="${task.id}">
                    </td>
                </tr>
                </tbody>
            </table>
        </section>
        <!-- ===============================================
                CARD VIEW
         =============================================== -->
        <section class="card-view"
                 th:if="${view == 'card'}">

            <div class="task-card-grid">

                <div class="task-card"
                     th:each="task : ${tasks}"
                     th:classappend="
                ${task.priority.name() == 'HIGH'} ? ' priority-high' :
                (${task.priority.name() == 'MEDIUM'} ? ' priority-medium' : ' priority-low')
             ">

                    <!-- Card Header -->
                    <div class="task-card-header">
                        <h3>
                            <i class="fa-solid fa-flag"></i>
                            <span th:text="${task.title}"></span>
                        </h3>

                    </div>

                    <!-- Card Body -->
                    <div class="task-card-body">
                        <p class="description"
                           th:text="${task.description}"></p>

                        <p class="meta">
                            <strong>Due Date:</strong>
                            <span th:text="${task.dueDate}"></span>
                        </p>

                        <p class="meta task-priority">
                            <strong>Priority:</strong>
                            <span th:text="${task.priority.label}"></span>
                        </p>

                        <p class="meta">
                            <strong>Status:</strong>
                            <span class="badge status"
                                  th:text="${task.status.label}"
                                  th:classappend="' status-' + task.status">
                    </span>
                        </p>
                    </div>

                    <!-- Card Actions -->
                    <div class="task-card-actions">

                        <button type="button" class="btn btn-view" th:onclick="'openViewModal(' + ${task.id} + ')'">
                            <i class="fa-solid fa-eye"></i> View
                        </button>

                        <button type="button"
                                class="btn btn-edit"
                                th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}"
                                th:onclick="'openEditModal(' + ${task.id} + ')'">
                            <i class="fa-solid fa-pen"></i> Edit
                        </button>

                        <span class="btn btn-edit btn-disabled"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}">
                              <i class="fa-solid fa-pen"></i> Edit
                        </span>

                        <button type="button"
                                class="btn btn-danger"
                                th:onclick="'deleteSingleTask(' + ${task.id} + ')'"
                                title="Delete Task">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </div>

                    <!-- Footer -->
                    <div class="task-card-footer">

                        <button class="btn btn-info mark-done-btn"
                                th:data-id="${task.id}"
                                th:if="${task.status != T(com.taskreminder.app.enums.TaskStatus).DONE}">
                            <i class="fa-solid fa-check"></i> Mark Done
                        </button>


                        <span class="completed-label"
                              th:if="${task.status == T(com.taskreminder.app.enums.TaskStatus).DONE}">
                    <i class="fa-solid fa-circle-check"></i> Done
                </span>

                    </div>

                </div>

            </div>

        </section>

        <!-- ===============================================
     CALENDAR VIEW
     =============================================== -->
        <section class="calendar-view"
                 th:if="${view == 'calendar'}">

            <div id="taskCalendar"></div>

        </section>
        <section id="bulkActions" class="bulk-actions hidden">
            <button class="btn btn-danger" id="bulkDeleteBtn">
                <i class="fa-solid fa-trash"></i> Delete Selected
            </button>
        </section>

        <!-- ===============================================
             PAGINATION
             =============================================== -->
        <section class="pagination-container"
                 th:if="${totalPages > 1}">

            <a class="btn"
               th:if="${currentPage > 0}"
               th:href="@{/api/tasks(
                   page=${currentPage - 1},
                   size=${size},
                   status=${status},
                   priority=${priority},
                   title=${title},
                   sortBy=${sortBy},
                   view=${view}
               )}">
                Previous
            </a>

            <span class="page-info">
                Page <strong th:text="${currentPage + 1}"></strong>
                of <strong th:text="${totalPages}"></strong>
            </span>

            <a class="btn"
               th:if="${currentPage < totalPages - 1}"
               th:href="@{/api/tasks(
                   page=${currentPage + 1},
                   size=${size},
                   status=${status},
                   priority=${priority},
                   title=${title},
                   sortBy=${sortBy},
                   view=${view}
               )}">
                Next
            </a>

        </section>

    </main>
    <!-- ===============================================
    ADD TASK/EDIT CARD
    =============================================== -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fa-solid fa-plus-circle me-2"></i>Add New Task
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fa-solid fa-i-cursor"></i> Task Title
                            </label>
                            <input type="text" id="taskTitle" class="form-control" placeholder="e.g., Design System Update" required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fa-solid fa-paragraph"></i> Description
                            </label>
                            <textarea id="taskDesc" class="form-control" rows="3" placeholder="What needs to be done?"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fa-solid fa-calendar-day"></i> Due Date
                            </label>
                            <input type="datetime-local" id="taskDueDate" class="form-control" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-spinner"></i> Status
                                </label>
                                <select id="taskStatus" class="form-select">
                                    <option value="PENDING">Pending</option>
                                    <option value="IN_PROGRESS">In Progress</option>
                                    <option value="COMPLETED">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-bolt"></i> Priority
                                </label>
                                <select id="taskPriority" class="form-select">
                                    <option value="LOW">Low</option>
                                    <option value="MEDIUM" selected>Medium</option>
                                    <option value="HIGH">High</option>
                                </select>
                            </div>
                        </div>

                        <div class="modal-footer px-0 pb-0 pt-4">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <button type="submit" id="submitBtn" class="btn btn-primary">
                                <i class="fa-solid fa-floppy-disk me-2"></i>Save Task
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================================
                       VIEW  TASK CARD
    ================================================= -->
    <div class="modal fade" id="viewTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-circle-info"></i> Task Overview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="info-group border-start border-4 border-primary">
                        <span class="info-label">Title</span>
                        <p id="viewTitle" class="info-value fs-5 fw-bold"></p>
                    </div>

                    <div class="info-group">
                        <span class="info-label">Detailed Description</span>
                        <p id="viewDesc" class="info-value"></p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-group">
                                <span class="info-label">Due Date</span>
                                <p id="viewDate" class="info-value"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <span class="info-label">Priority</span>
                                <div id="viewPriority" class="info-value"></div>
                            </div>
                        </div>
                    </div>

                    <div class="info-group mb-0">
                        <span class="info-label">Current Status</span>
                        <div id="viewStatusBadge" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
    <div th:replace="~{fragments/footer :: footer}"></div>

<script th:if="${view == 'calendar'}"
        src="/js/calendar.js"></script>
<script>
    function sendEmailReport() {
    fetch('/api/tasks/export-csv?action=email')
        .then(response => {
            if(response.ok) {
                alert('Report has been sent to your email!');
            } else {
                alert('Error: ' + response.status);
            }
        })
        .catch(err => console.error("Request failed", err));
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/add-task.js}"></script>
<script th:src="@{/js/filterButton.js}"></script>
<script th:src="@{/js/notifications.js}"></script>
<script src="/js/live-time.js"></script>
<script src="/js/header.js"></script>
<script th:src="@{/js/dashboard-charts.js}"></script>
<script src="/js/task-status.js"></script>
<script src="/js/theme.js"></script>
<script src="/js/undo-toast.js"></script>
<script src="/js/task-bulk-delete.js"></script>
</body>
</html>
